@page "/note-editor"
@page "/note-editor/{NoteId:int}"
@inject ISender Sender
@inject NavigationManager NavigationManager

@if (isEditMode && Note != null)
{
    <PageTitle>Edit Note</PageTitle>
    <h3>Edit Note</h3>
    <p>Editing note with title: @Note.Title</p>
    <a href="/notes" class="btn btn-secondary mb-2">Back to Notes</a>
}
else
{
    <PageTitle>Create Note</PageTitle>
    <h3>Create Note</h3>
    <a href="/notes" class="btn btn-secondary mb-2">Back to Notes</a>
}

@if (Note != null)
{
    <EditForm Model="Note" OnSubmit="HandleSubmit" FormName="NoteEditorForm">
        <InputText @bind-Value="Note!.Title" placeholder="Title" class="form-control mb-2" />
        <InputTextArea @bind-Value="Note.Content" placeholder="Content" class="form-control mb-2" rows="5" />
        <label>Select a published date</label>
        <InputDate @bind-Value="Note.PublishedAt" class="form-control mb-2" />
        <div class="form-check">
            <InputCheckbox @bind-Value="Note.IsPublished" class="form-check-input mb-2" />
            <label class="form-check-label mb-2">Is Published</label>
        </div>
        <button type="submit" class="btn btn-primary mt-3 w-100">@(isEditMode ? "Update Note" : "Create Note")</button>
    </EditForm>
    @if (isEditMode)
    {
        <form @onsubmit="DeleteNote" @formname="DeleteNoteForm" method="post">
            <button type="submit" class="btn btn-danger mt-2">Delete Note</button>
            <AntiforgeryToken />
        </form>
    }
}

<span class="text-danger">@errorMessage</span>


@code {
    private bool isEditMode => NoteId != null;
    private string errorMessage = string.Empty;
    [SupplyParameterFromForm]
    private NoteModel? Note { get; set; }
    [Parameter]
    public int? NoteId { get; set; }
    protected override async Task OnParametersSetAsync()
    {
        if (isEditMode)
        {
            var result = await Sender.Send(new GetNoteByIdQuery
            {
                Id = NoteId!.Value
            });

            if (result.IsSuccessful)
            {
                Note ??= result.Value.Adapt<NoteModel>();
                Note.Id = NoteId.Value;
            }
            else
            {
                SetErrorMessage(result.ErrorMessage);
            }
        }
        else
        {
            Note ??= new NoteModel();
        }
    }
    private async Task HandleSubmit()
    {
        if (isEditMode)
        {
            var command = Note.Adapt<UpdateNoteCommand>();
            var result = await Sender.Send(command);

            if (result.IsSuccessful)
            {
                Note = result.Value.Adapt<NoteModel>();
                Console.WriteLine("Note updated successfully.");
                NavigationManager.NavigateTo("/notes");
            }
            else
            {
                SetErrorMessage(result.ErrorMessage);
            }
        }
        else
        {
            var command = Note.Adapt<CreateNoteCommand>();
            var result = await Sender.Send(command);

            if (result.HasFailed)
            {
                SetErrorMessage(result.ErrorMessage);
                return;
            }

            Note = result.Adapt<NoteModel>();
            Console.WriteLine("Note created with ID: " + Note.Id);
        }
    }

    private async Task DeleteNote()
    {
        if (isEditMode)
        {
            var command = new DeleteNoteCommand
            {
                Id = NoteId!.Value
            };
            var result = await Sender.Send(command);
            if (result.IsSuccessful)
            {
                Console.WriteLine("Note deleted successfully.");
                NavigationManager.NavigateTo("/notes");
            }
            else
            {
                Console.WriteLine("Failed to delete the note.");
            }
        }
    }

    private void SetErrorMessage(string? message)
    {
        errorMessage = message ?? string.Empty;
    }
}